#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook to detect sensitive files
# Install: ln -sf ../../scripts/pre-commit-secrets .git/hooks/pre-commit
# Or add to your dotfiles hooks

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Find lib-organizer binary
find_binary() {
    # Check if installed globally
    if command -v lib-organizer &> /dev/null; then
        echo "lib-organizer"
        return
    fi

    # Check cargo target directories
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

    for dir in "$script_dir/.." "$HOME/.cargo" "$(git rev-parse --show-toplevel 2>/dev/null)"; do
        if [[ -x "$dir/target/release/lib-organizer" ]]; then
            echo "$dir/target/release/lib-organizer"
            return
        fi
        if [[ -x "$dir/target/debug/lib-organizer" ]]; then
            echo "$dir/target/debug/lib-organizer"
            return
        fi
    done

    echo ""
}

BINARY=$(find_binary)

if [[ -z "$BINARY" ]]; then
    echo -e "${YELLOW}Warning: lib-organizer not found, skipping secrets check${NC}"
    echo "Install with: cargo install --path crates/lib-organizer"
    exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [[ -z "$STAGED_FILES" ]]; then
    exit 0
fi

# Create temp file with staged paths
TEMP_FILE=$(mktemp)
trap 'rm -f "$TEMP_FILE"' EXIT

echo "$STAGED_FILES" | while read -r file; do
    if [[ -f "$file" ]]; then
        echo "$file"
    fi
done > "$TEMP_FILE"

if [[ ! -s "$TEMP_FILE" ]]; then
    exit 0
fi

# Run secrets scan on staged files
echo -e "${YELLOW}Checking staged files for secrets...${NC}"

# Use the secrets command with --strict to fail on detection
if ! "$BINARY" secrets --content --strict $(cat "$TEMP_FILE") 2>&1; then
    echo ""
    echo -e "${RED}=== COMMIT BLOCKED ===${NC}"
    echo -e "${RED}Sensitive files detected in staged changes.${NC}"
    echo ""
    echo "Options:"
    echo "  1. Remove sensitive files from commit: git reset HEAD <file>"
    echo "  2. Add to .gitignore if they shouldn't be tracked"
    echo "  3. Store encrypted with age in a secure location"
    echo "  4. Bypass (not recommended): git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}No sensitive files detected.${NC}"
exit 0
